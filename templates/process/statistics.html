{% extends "process/base.html" %}
{% load static from staticfiles %}
{% block title %}统计结果页面{% endblock %}
{% block head %}
    <link rel="stylesheet" type="text/css" media="screen" href="{% static "css/jquery-confirm.min.css" %}" />
    <script type="text/javascript" src="{% static "js/jquery-confirm.min.js" %}" charset="UTF-8"></script>
    <script type="text/javascript" src="{% static "js/echarts3.js" %}"></script>
    <script type="text/javascript">
    var myChart;
    function flash(text,time)
    {
        $("#loading_text").html(text);
        $("#loading_div2").css('display','block');
        if(time!=0)setTimeout(function(){
            $("#loading_div2").css('display','none');
        },time);
    }

    function submit_form()
    {
        flash("正在查询,请稍等!", 60000);
        $.ajaxSetup({
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
        });
        var train_region = $("#region_select").find("option:selected").val();
        var date_start = $("#date_start").val();
        var date_end = $("#date_end").val();
        $.ajax({
            type: "GET",
            url: "{% url 'process:load_region_statistics' %}?query_region="+train_region+"&date_start="+date_start+"&date_end="+date_end,
            success: function (result) {
                if (result["code"] == 0) {
                    $("#loading_div2").css('display','none');
                    var addr=result["addr"];
                    if(typeof addr != "object"){
                        $.get(addr).done(function (rtn_json) {
                            myChart.setOption(rtn_json);
                        });
                    }
                    else
                    {
                        return "返回的数据格式不对!";
                    }
            }
            else {
                alert(result.message);
            }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.table([{
                    "错误类型": jqXHR,
                    "错误信息": textStatus,
                    "http状态": errorThrown
                }])
            }
        });

    }
    </script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div id="toolbar">
           <div class="form-inline" role="form">
            <form id = "train_form" class="form-inline"  action="" method="POST">
               <div class="form-group">
                    <label for="query_region" class="control-label"><small>查询区域:</small></label>
                    <select id="region_select" class="form-control input-sm" name="query_region" style="width:80px;">
                          {% for k,v in region.items %}
                              {% ifequal forloop.counter0 0 %}
                                  <option value="{{ v }}" selected="selected">{{ k }}</option>
                              {% else %}
                                   <option value="{{ v }}">{{ k }}</option>
                              {% endifequal %}
                          {% endfor %}
                    </select>
               </div>&nbsp;
               <div class="form-group">
                    <label for="date_start" ><small>时间:</small></label>
                    <input id = "date_start" class="form-control form-date input-sm" type="text" name="date_start" style="width: 120px;" data-date-format="yyyy-mm-dd" value="2017-02-01" >—
                    <input id = "date_end"  class="form-control form-date input-sm"  type="text" name="date_end" style="width: 120px;"  data-date-format="yyyy-mm-dd" value="2017-02-28" >
               </div>&nbsp;
            <div class="form-group">
                <input onclick="submit_form()" class="btn btn-primary btn-sm" style="width: 60px;" value="查询"/>
                {% csrf_token %}
            </div>&nbsp;
                </form>
           </div>
    </div>
    <div id="echart_body" style="width: 1200px;height:800px;"></div>
  </div>
</div>
{% endblock %}
{% block endscript %}
    <script type="text/javascript">
        $('.form-date').datetimepicker({
          language:'zh-CN',
          weekStart:1,
          todayBtn:1,
          autoclose:1,
          todayHighlight:1,
          startView:2,
          minView:2,
          forceParse:0
        });
        myChart = echarts.init(document.getElementById('echart_body'));
    </script>
{% endblock %}